<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>길찾기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .search-box {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            width: 48%;
            position: relative;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .search-btn {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-start;
        }
        .search-btn:hover {
            background-color: #1976D2;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .results {
            position: absolute;
            top: 90px;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            background-color: #f9f9f9;
        }
        .result-item:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>길찾기</h1>
    <div class="search-box">
        <div class="input-group">
            <label for="start">출발지</label>
            <input type="text" id="start" name="start" placeholder="출발지를 입력하세요">
            <button type="button" class="search-btn" onclick="searchPlace('start')">검색</button>
            <div id="results-start" class="results"></div> <!-- 출발지 검색 결과 표시 영역 -->
        </div>
        <div class="input-group">
            <label for="end">도착지</label>
            <input type="text" id="end" name="end" placeholder="도착지를 입력하세요">
            <button type="button" class="search-btn" onclick="searchPlace('end')">검색</button>
            <div id="results-end" class="results"></div> <!-- 도착지 검색 결과 표시 영역 -->
        </div>
    </div>
    <button type="button" class="btn" onclick="calculateDistance()">길찾기</button>
    <div id="map"></div>
</div>

<script>
    // 좌표 정보를 저장할 객체
    let coordinates = {
        start: null,
        end: null
    };

    // 장소 검색을 처리하는 함수
    function searchPlace(type) {
        const place = document.getElementById(type).value;
        if (!place) {
            alert(type === 'start' ? '출발지를 입력하세요.' : '도착지를 입력하세요.');
            return;
        }

        // AJAX 요청을 통해 각각의 장소 검색을 처리합니다.
        fetch(`/api/searchPlace?place=${encodeURIComponent(place)}`, {
            method: 'GET',
        })
            .then(response => response.json())
            .then(data => {
                // 서버로부터 받은 검색 결과를 처리하는 부분
                displayResults(data, type);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('검색 중 오류가 발생했습니다.');
            });
    }

    // 검색 결과를 표시하는 함수
    function displayResults(data, type) {
        const resultsDiv = document.getElementById(`results-${type}`);
        resultsDiv.innerHTML = ''; // 이전 결과 초기화

        // 검색 결과가 있을 경우 리스트 형태로 보여줌
        data.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerText = `${stripHtmlTags(item.title)} - ${item.address}`;
            div.onclick = () => selectLocation(item, type);
            resultsDiv.appendChild(div);
        });
    }

    // HTML 태그를 제거하는 함수
    function stripHtmlTags(str) {
        return str.replace(/<[^>]*>/g, '');
    }

    // X 좌표 (mapx)를 가공하는 함수 (134.xxx 형식으로 변환)
    function formatMapx(coordinate) {
        // 좌표 문자열에서 필요한 부분만 추출하여 가공
        return `134.${coordinate.slice(3)}`;
    }

    // Y 좌표 (mapy)를 가공하는 함수 (36.xxxx 형식으로 변환)
    function formatMapy(coordinate) {
        // 좌표 문자열에서 필요한 부분만 추출하여 가공
        return `36.${coordinate.slice(2)}`;
    }

    // 사용자가 위치를 선택했을 때 실행되는 함수
    function selectLocation(item, type) {
        const cleanTitle = stripHtmlTags(item.title); // HTML 태그를 제거한 텍스트
        document.getElementById(type).value = cleanTitle;

        // 좌표를 저장해둠
        coordinates[type] = {
            mapx: formatMapx(item.mapx),
            mapy: formatMapy(item.mapy)
        };

        // 선택 후 검색 결과를 지웁니다.
        document.getElementById(`results-${type}`).innerHTML = '';
    }

    // 출발지와 도착지의 거리를 계산하는 함수
    function calculateDistance() {
        if (!coordinates.start || !coordinates.end) {
            alert('출발지와 도착지를 모두 선택하세요.');
            return;
        }

        console.log('출발지 좌표:', coordinates.start);
        console.log('도착지 좌표:', coordinates.end);

        // 좌표 정보를 URL 파라미터로 전달하여 거리를 계산합니다.
        const url = `/api/calcDistance?departureMapx=${coordinates.start.mapx}&departureMapy=${coordinates.start.mapy}&arrivalMapx=${coordinates.end.mapx}&arrivalMapy=${coordinates.end.mapy}`;

        fetch(url, {
            method: 'GET',
        })
            .then(response => response.json())
            .then(data => {
                // 전체 JSON 결과를 문자열로 변환하여 alert로 표시
                console.log('전체 json : ', data);
                alert(JSON.stringify(data, null, 2));
            })
            .catch(error => {
                console.error('Error:', error);
                alert('거리 계산 중 오류가 발생했습니다.');
            });
    }
</script>

</body>
</html>